<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>橘蘋課程資源查詢工具</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/x-icon" href="favicon.png">
</head>

<body class="bg-gray-100 min-h-screen p-4">
    <div id="authLoading" class="max-w-xl mx-auto bg-white rounded-xl shadow p-6 flex items-center text-gray-700 mb-4">
        <svg class="animate-spin h-5 w-5 mr-2 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none"
            viewBox="0 0 24 24" aria-hidden="true">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <span>正在驗證邀請碼…</span>
    </div>
    <div id="app" class="max-w-xl mx-auto bg-white rounded-xl shadow p-6 hidden">
        <h1 class="text-2xl font-bold mb-4">橘蘋課程資源查詢工具</h1>
        <p class="text-sm text-gray-600 mb-4">選擇後，系統會顯示對應的 6 位數密碼與連結，請轉告學生該密碼。</p>

        <form class="space-y-4" id="form">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">課程</label>
                <select id="course" class="w-full px-3 py-2 border rounded-lg"></select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">課堂</label>
                <select id="lesson" class="w-full px-3 py-2 border rounded-lg" disabled></select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">章節</label>
                <select id="chapter" class="w-full px-3 py-2 border rounded-lg" disabled></select>
            </div>
        </form>

        <div id="info" class="mt-6 text-base"></div>
    </div>

    <script>
        // 固定後端位址
        const API_URL = 'https://script.google.com/macros/s/AKfycbwmDDHrIezTfevpMdreO8nmX_r3D0Pv3r8KTsckn3tC0b5ZWnetTbiPvpJ7CcauWqG9/exec';
        // 讀取網址參數
        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }

        // 先驗證教師端 uuid，成功才顯示畫面
        async function verifyTeacherUUID(uuid = getQueryParam('uuid')) {
            if (!uuid) return false;
            try {
                const params = new URLSearchParams({ action: 'teacher_auth', uuid });
                const url = `${API_URL}?${params.toString()}`;
                const res = await fetch(url);
                if (!res.ok) return false;
                const data = await res.json();
                return data.status === 'success';
            } catch (e) {
                return false;
            }
        }

        const courseSel = document.getElementById('course');
        const lessonSel = document.getElementById('lesson');
        const chapterSel = document.getElementById('chapter');
        const info = document.getElementById('info');
        const authLoading = document.getElementById('authLoading');

        function setSelectOptions(select, items, placeholder = '請選擇', enable = true) {
            select.innerHTML = '';
            const ph = document.createElement('option');
            ph.value = '';
            ph.textContent = placeholder;
            select.appendChild(ph);
            if (Array.isArray(items)) {
                for (const item of items) {
                    const opt = document.createElement('option');
                    opt.value = item;
                    opt.textContent = item;
                    select.appendChild(opt);
                }
            }
            select.disabled = !enable;
        }
        function setLoading(select) { setSelectOptions(select, [], '載入中...', false); }
        function resetDependent(select, text = '請先選擇上一步') { setSelectOptions(select, [], text, false); }

        async function fetchList(level, extra = {}) {
            const params = new URLSearchParams({ action: 'list', level });
            for (const [k, v] of Object.entries(extra)) {
                if (v !== undefined && v !== null && v !== '') params.append(k, v);
            }
            const url = `${API_URL}?${params.toString()}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error(`伺服器錯誤: ${res.status}`);
            const data = await res.json();
            if (data.status !== 'success') throw new Error(data.message || '載入失敗');
            return data.items || [];
        }

        // 改由後端提供當日 PIN，避免時區不同步
        async function fetchPin(course, lesson, chapter) {
            const uuid = getQueryParam('uuid');
            const params = new URLSearchParams({ action: 'pin', '課程': course, '課堂': lesson, '章節': chapter, uuid });
            const url = `${API_URL}?${params.toString()}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error(`伺服器錯誤: ${res.status}`);
            const data = await res.json();
            if (data.status !== 'success') throw new Error(data.message || '無法取得PIN');
            return data.pin;
        }

        async function loadCourses() {
            setLoading(courseSel); resetDependent(lessonSel); resetDependent(chapterSel);
            try {
                const items = await fetchList('course');
                setSelectOptions(courseSel, items, '請選擇課程', true);
            } catch (e) { setSelectOptions(courseSel, [], `載入失敗：${e.message}`, false); }
        }
        async function loadLessons(course) {
            setLoading(lessonSel); resetDependent(chapterSel);
            try {
                const items = await fetchList('lesson', { '課程': course });
                setSelectOptions(lessonSel, items, '請選擇課堂', true);
            } catch (e) { setSelectOptions(lessonSel, [], `載入失敗：${e.message}`, false); }
        }
        async function loadChapters(course, lesson) {
            setLoading(chapterSel);
            try {
                const items = await fetchList('chapter', { '課程': course, '課堂': lesson });
                setSelectOptions(chapterSel, items, '請選擇章節', true);
            } catch (e) { setSelectOptions(chapterSel, [], `載入失敗：${e.message}`, false); }
        }

        async function preview(course, lesson, chapter) {
            info.textContent = '檢查中...'; info.className = 'mt-6 text-base text-gray-600';
            try {
                const pin = await fetchPin(course, lesson, chapter);
                const params = new URLSearchParams({ '課程': course, '課堂': lesson, '章節': chapter, '密碼': pin });
                const url = `${API_URL}?${params.toString()}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`伺服器錯誤: ${res.status}`);
                const data = await res.json();
                if (data.status === 'success') {
                    // pin 已由後端提供
                    const links = (data.links && data.links.length) ? data.links : [data.link];
                    const list = links.map((lnk, i) => `<li class="mb-1"><a class="text-blue-600 hover:underline break-all" href="${lnk}" target="_blank">連結 ${i + 1}</a></li>`).join('');
                    info.innerHTML = `
            <div class="p-4 border rounded-lg">
              <div class="text-sm text-gray-500">此選擇的 6 位數密碼</div>
              <div class="text-3xl font-mono font-bold tracking-widest my-1">${pin}</div>
              <div class="text-sm text-gray-500 mt-2">課程資源</div>
              <ul class="list-disc pl-5 mt-1">${list}</ul>
            </div>`;
                    info.className = 'mt-6 text-base text-gray-800';
                } else if (data.status === 'not_found') {
                    info.textContent = '找不到對應的資料。'; info.className = 'mt-6 text-base text-red-600';
                } else {
                    info.textContent = `錯誤：${data.message || '未知錯誤'}`; info.className = 'mt-6 text-base text-red-600';
                }
            } catch (e) {
                info.textContent = `錯誤：${e.message}`; info.className = 'mt-6 text-base text-red-600';
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            let ok = await verifyTeacherUUID();
            if (!ok) {
                if (authLoading) authLoading.querySelector('span').textContent = '請輸入邀請碼以繼續';
                const input = prompt('請輸入邀請碼：');
                if (input && input.trim()) {
                    if (authLoading) authLoading.querySelector('span').textContent = '正在驗證邀請碼…';
                    ok = await verifyTeacherUUID(input.trim());
                    if (ok) {
                        const url = new URL(window.location.href);
                        url.searchParams.set('uuid', input.trim());
                        history.replaceState(null, '', url.toString());
                    }
                }
            }
            if (!ok) {
                if (authLoading) authLoading.querySelector('span').textContent = '無法開啟教師介面：邀請碼缺失或錯誤。';
                return;
            }
            // 解鎖主畫面
            if (authLoading) authLoading.classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            loadCourses();
            courseSel.addEventListener('change', () => {
                const c = courseSel.value; info.textContent = '';
                if (!c) { resetDependent(lessonSel); resetDependent(chapterSel); return; }
                loadLessons(c);
            });
            lessonSel.addEventListener('change', () => {
                const c = courseSel.value, l = lessonSel.value; info.textContent = '';
                if (!c || !l) { resetDependent(chapterSel); return; }
                loadChapters(c, l);
            });
            chapterSel.addEventListener('change', () => {
                const c = courseSel.value, l = lessonSel.value, ch = chapterSel.value; info.textContent = '';
                if (!c || !l || !ch) return;
                preview(c, l, ch);
            });
        });
    </script>
</body>

</html>
