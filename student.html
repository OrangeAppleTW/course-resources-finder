<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <title>æ©˜è˜‹èª²ç¨‹è³‡æºæŸ¥è©¢å·¥å…·</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/x-icon" href="favicon.png">
    <style>
        /* è®“è¼‰å…¥ä¸­çš„å‹•ç•«è½‰èµ·ä¾† */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-xl mx-auto bg-white rounded-xl shadow p-6">
        <h1 class="text-2xl font-bold mb-4">æ©˜è˜‹èª²ç¨‹è³‡æºæŸ¥è©¢å·¥å…·</h1>
        <p class="text-sm text-gray-600 mb-4">é¸æ“‡èª²ç¨‹ã€èª²å ‚å’Œç« ç¯€å¾Œï¼Œè¼¸å…¥è€å¸«æä¾›çš„ 6 ä½æ•¸å¯†ç¢¼å¾Œå³å¯æŸ¥çœ‹é€£çµã€‚</p>
        <form id="searchForm" class="space-y-4">
            <div>
                <label for="course" class="block text-sm font-medium text-gray-700 mb-1">èª²ç¨‹</label>
                <select id="course" name="course" required class="w-full px-3 py-2 border rounded-lg">
                    <option value="Roblox AI éŠæˆ²è¨­è¨ˆç­ï¼šåˆéšç­">Roblox AI éŠæˆ²è¨­è¨ˆç­ï¼šåˆéšç­</option>
                </select>
            </div>

            <div>
                <label for="lesson" class="block text-sm font-medium text-gray-700 mb-1">èª²å ‚</label>
                <select id="lesson" name="lesson" required class="w-full px-3 py-2 border rounded-lg">
                </select>
            </div>

            <div>
                <label for="chapter" class="block text-sm font-medium text-gray-700 mb-1">ç« ç¯€</label>
                <select id="chapter" name="chapter" required class="w-full px-3 py-2 border rounded-lg">
                </select>
            </div>

            <div id="passwordGroup" class="hidden">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">å¯†ç¢¼</label>
                <div>
                    <input inputmode="numeric" pattern="[0-9]{6}" maxlength="6" id="password" name="password"
                        title="è«‹è¼¸å…¥ 6 ä½æ•¸å­—" class="w-full px-3 py-2 border rounded-lg" placeholder="è«‹è¼¸å…¥ 6 ä½æ•¸å¯†ç¢¼"
                        autocomplete="one-time-code">
                </div>
            </div>

            <!-- æŸ¥è©¢æŒ‰éˆ•å·²ç§»é™¤ï¼šè¼¸å…¥ 6 ä½æ•¸å¯†ç¢¼å¾Œè‡ªå‹•æŸ¥è©¢ -->
        </form>
        <div id="result" class="mt-6 text-base"></div>
    </div>

    <script>
        // ğŸš¨ è«‹å°‡é€™è£¡æ›æˆä½ è‡ªå·±çš„ API ç¶²å€ï¼
        const API_URL = 'https://script.google.com/macros/s/AKfycby8hkRr4ZpdUlp0fdZ5AsWj71DemnkE0QAzuglpDaolOR1Yl-sqvVyZeGQEvFFhiS_8/exec';

        // å–å¾—å…ƒç´ åƒç…§
        const courseSelect = document.getElementById('course');
        const lessonSelect = document.getElementById('lesson');
        const chapterSelect = document.getElementById('chapter');
        const passwordInput = document.getElementById('password');
        const passwordGroup = document.getElementById('passwordGroup');
        // å·²ç§»é™¤æç¤ºæŒ‰éˆ•èˆ‡ç›¸é—œå…ƒç´ 

        // å…±ç”¨ï¼šè¨­å®š Select ç‚ºæŸç¨®ç‹€æ…‹
        function setSelectOptions(select, items, placeholder = 'è«‹é¸æ“‡', enable = true) {
            select.innerHTML = '';
            const ph = document.createElement('option');
            ph.value = '';
            ph.textContent = placeholder;
            select.appendChild(ph);

            if (Array.isArray(items)) {
                for (const item of items) {
                    const opt = document.createElement('option');
                    opt.value = item;
                    opt.textContent = item;
                    select.appendChild(opt);
                }
            }
            select.disabled = !enable;
        }

        function setLoading(select) {
            setSelectOptions(select, [], 'è¼‰å…¥ä¸­...', false);
        }

        function resetDependent(select, text = 'è«‹å…ˆé¸æ“‡ä¸Šä¸€æ­¥') {
            setSelectOptions(select, [], text, false);
        }

        // å‘¼å«å¾Œç«¯å–å¾—æ¸…å–®
        async function fetchList(level, extraParams = {}) {
            const params = new URLSearchParams({ action: 'list', level });
            if (extraParams) {
                for (const [k, v] of Object.entries(extraParams)) {
                    if (v !== undefined && v !== null && v !== '') params.append(k, v);
                }
            }
            const url = `${API_URL}?${params.toString()}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error(`ä¼ºæœå™¨éŒ¯èª¤ï¼Œç‹€æ…‹ç¢¼: ${res.status}`);
            const data = await res.json();
            if (data.status !== 'success') throw new Error(data.message || 'è¼‰å…¥å¤±æ•—');
            return data.items || [];
        }

        // åœ¨æŸ¥è©¢æœŸé–“æš«æ™‚é–å®š/è§£é–ä¸‰å€‹ä¸‹æ‹‰é¸å–®
        let prevDisabledStates = null;
        function lockSelects() {
            prevDisabledStates = {
                course: courseSelect.disabled,
                lesson: lessonSelect.disabled,
                chapter: chapterSelect.disabled,
            };
            courseSelect.disabled = true;
            lessonSelect.disabled = true;
            chapterSelect.disabled = true;
        }
        function unlockSelects() {
            if (!prevDisabledStates) return;
            courseSelect.disabled = prevDisabledStates.course;
            lessonSelect.disabled = prevDisabledStates.lesson;
            chapterSelect.disabled = prevDisabledStates.chapter;
            prevDisabledStates = null;
        }

        // åœ¨æŸ¥è©¢æœŸé–“é–å®š/è§£é–å¯†ç¢¼è¼¸å…¥æ¡†
        let prevPasswordDisabled = null;
        function lockPassword() {
            prevPasswordDisabled = passwordInput.disabled;
            passwordInput.disabled = true;
        }

        // åƒ…ç•¶ä¸‰å€‹ä¸‹æ‹‰éƒ½å·²é¸å®šæœ‰æ•ˆå€¼æ™‚æ‰å¯è¼¸å…¥å¯†ç¢¼
        function hasAllSelections() {
            return Boolean(courseSelect.value && lessonSelect.value && chapterSelect.value);
        }
        function unlockPassword() {
            if (prevPasswordDisabled === null) return;
            passwordInput.disabled = prevPasswordDisabled;
            prevPasswordDisabled = null;
        }

        // ç´šè¯è¼‰å…¥
        async function loadCourses() {
            try {
                setLoading(courseSelect);
                resetDependent(lessonSelect);
                resetDependent(chapterSelect);
                const items = await fetchList('course');
                if (items.length === 0) {
                    setSelectOptions(courseSelect, [], 'ç„¡å¯ç”¨èª²ç¨‹', false);
                } else {
                    setSelectOptions(courseSelect, items, 'è«‹é¸æ“‡èª²ç¨‹', true);
                }
            } catch (err) {
                setSelectOptions(courseSelect, [], `è¼‰å…¥å¤±æ•—ï¼š${err.message}`, false);
            }
        }

        async function loadLessons(course) {
            try {
                setLoading(lessonSelect);
                resetDependent(chapterSelect);
                const items = await fetchList('lesson', { 'èª²ç¨‹': course });
                if (items.length === 0) {
                    setSelectOptions(lessonSelect, [], 'ç„¡å¯ç”¨èª²å ‚', false);
                } else {
                    setSelectOptions(lessonSelect, items, 'è«‹é¸æ“‡èª²å ‚', true);
                }
            } catch (err) {
                setSelectOptions(lessonSelect, [], `è¼‰å…¥å¤±æ•—ï¼š${err.message}`, false);
            }
        }

        async function loadChapters(course, lesson) {
            try {
                setLoading(chapterSelect);
                const items = await fetchList('chapter', { 'èª²ç¨‹': course, 'èª²å ‚': lesson });
                if (items.length === 0) {
                    setSelectOptions(chapterSelect, [], 'ç„¡å¯ç”¨ç« ç¯€', false);
                } else {
                    setSelectOptions(chapterSelect, items, 'è«‹é¸æ“‡ç« ç¯€', true);
                }
            } catch (err) {
                setSelectOptions(chapterSelect, [], `è¼‰å…¥å¤±æ•—ï¼š${err.message}`, false);
            }
        }

        // åˆå§‹åŒ–èˆ‡äº‹ä»¶ç›£è½
        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹ç‹€æ…‹
            setLoading(courseSelect);
            resetDependent(lessonSelect);
            resetDependent(chapterSelect);
            hidePassword();
            // è§£æ URL é è¨­åƒæ•¸ï¼ˆæ”¯æ´è‹±æ–‡/ä¸­æ–‡éµï¼‰ï¼š?course=...&lesson=...&chapter=...
            const urlParams = new URLSearchParams(window.location.search);
            const presetCourse = urlParams.get('course') || urlParams.get('èª²ç¨‹');
            const presetLesson = urlParams.get('lesson') || urlParams.get('èª²å ‚');
            const presetChapter = urlParams.get('chapter') || urlParams.get('ç« ç¯€');
            const presetPin = urlParams.get('password') || urlParams.get('pin') || urlParams.get('å¯†ç¢¼');

            // æ ¹æ“šåƒæ•¸æ±ºå®šæ˜¯å¦è·³éæ¸…å–®è«‹æ±‚
            (async () => {
                if (!presetCourse) {
                    // ç„¡ä»»ä½•é è¨­ï¼Œèµ°åŸæœ¬æµç¨‹
                    await loadCourses();
                    return;
                }

                // æœ‰ courseï¼Œç›´æ¥é¡¯ç¤ºä¸¦è·³éèª²ç¨‹æ¸…å–®è«‹æ±‚ï¼Œä¸”é–å®šèª²ç¨‹é¸å–®
                setSelectOptions(courseSelect, [presetCourse], 'è«‹é¸æ“‡èª²ç¨‹', false);
                courseSelect.value = presetCourse;

                if (!presetLesson && !presetChapter) {
                    // åƒ… courseï¼šç›´æ¥è«‹ã€Œèª²å ‚ã€æ¸…å–®
                    await loadLessons(presetCourse);
                    return;
                }

                // æœ‰ course + lessonï¼Œå…ˆå›ºå®šå…©è€…ï¼Œä¸è«‹èª²å ‚æ¸…å–®ï¼Œç›´æ¥è«‹ç« ç¯€æ¸…å–®ï¼Œä¸”é–å®šèª²å ‚é¸å–®
                setSelectOptions(lessonSelect, [presetLesson], 'è«‹é¸æ“‡èª²å ‚', false);
                lessonSelect.value = presetLesson || '';

                if (!presetChapter) {
                    await loadChapters(presetCourse, presetLesson);
                    return;
                }

                // æœ‰ course + lesson + chapterï¼šä¸è«‹ä»»ä½•æ¸…å–®ï¼Œç›´æ¥æº–å‚™æŸ¥é€£çµï¼Œä¸”é–å®šç« ç¯€é¸å–®
                setSelectOptions(chapterSelect, [presetChapter], 'è«‹é¸æ“‡ç« ç¯€', false);
                chapterSelect.value = presetChapter;

                // è‹¥ç¶²å€å·²æœ‰ 6 ç¢¼å¯†ç¢¼ï¼Œç›´æ¥æŸ¥è©¢é€£çµï¼›å¦å‰‡é¡¯ç¤ºå¯†ç¢¼æ¬„ä½ç­‰å¾…è¼¸å…¥
                // è‹¥ç¶²å€å·²æœ‰ 6 ç¢¼å¯†ç¢¼ï¼Œç›´æ¥æŸ¥è©¢é€£çµï¼›å¦å‰‡åœ¨ä¸‰è€…é½Šå…¨æ™‚é¡¯ç¤ºå¯†ç¢¼æ¬„ä½
                if (hasAllSelections() && presetPin && /^\d{6}$/.test(presetPin)) {
                    passwordInput.value = presetPin;
                    searchUrl();
                } else if (hasAllSelections()) {
                    showPassword(true);
                    const resultDiv = document.getElementById('result');
                    resultDiv.innerHTML = 'è¼¸å…¥å¯†ç¢¼å¾Œæœƒè‡ªå‹•é€å‡ºæŸ¥è©¢';
                    resultDiv.className = 'mt-6 text-base font-medium text-amber-600';
                } else {
                    hidePassword(true);
                }
            })();

            // ç„¡æç¤ºæŒ‰éˆ•ï¼Œæ•…ç„¡éœ€äº‹ä»¶è™•ç†

            courseSelect.addEventListener('change', () => {
                const c = courseSelect.value;
                hidePassword(true);
                clearResult();
                if (!c) {
                    resetDependent(lessonSelect);
                    resetDependent(chapterSelect);
                    return;
                }
                loadLessons(c);
            });

            lessonSelect.addEventListener('change', () => {
                const c = courseSelect.value;
                const l = lessonSelect.value;
                hidePassword(true);
                clearResult();
                if (!c || !l) {
                    resetDependent(chapterSelect);
                    return;
                }
                loadChapters(c, l);
            });

            chapterSelect.addEventListener('change', () => {
                const c = courseSelect.value;
                const l = lessonSelect.value;
                const ch = chapterSelect.value;
                hidePassword(true);
                if (!c || !l || !ch) {
                    clearResult();
                    return;
                }
                previewLinks(c, l, ch);
            });

            // åƒ…å…è¨±6ä½æ•¸å­—è¼¸å…¥ï¼Œè¼¸å…¥æ»¿ 6 ä½è‡ªå‹•æŸ¥è©¢
            passwordInput.addEventListener('input', () => {
                const digits = (passwordInput.value || '').replace(/\D/g, '').slice(0, 6);
                if (digits !== passwordInput.value) passwordInput.value = digits;
                if (digits.length === 6) {
                    searchUrl();
                }
            });
        });


        // é˜»æ­¢è¡¨å–®é è¨­æäº¤ï¼ˆé¿å… Enter é€ æˆé é¢é‡æ•´ï¼‰
        const searchForm = document.getElementById('searchForm');
        searchForm.addEventListener('submit', function (event) { event.preventDefault(); });

        // è™•ç†ä½¿ç”¨è€…æŸ¥è©¢ (ä½¿ç”¨ fetch API)
        let isQuerying = false;
        async function searchUrl() {
            if (API_URL === 'è²¼ä¸Šä½ éƒ¨ç½²å¾Œçš„ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€') {
                showError({ message: 'éŒ¯èª¤ï¼šå°šæœªè¨­å®š API_URL è®Šæ•¸ã€‚' });
                return;
            }

            const resultDiv = document.getElementById('result');
            if (isQuerying) return; // é¿å…é‡è¤‡é€å‡º
            isQuerying = true;
            lockSelects();
            lockPassword();
            try { passwordInput.blur(); } catch (e) { }
            resultDiv.innerHTML = 'æ­£åœ¨æŸ¥è©¢ä¸­...';
            resultDiv.className = 'mt-6 text-base font-medium text-gray-500'; // é‡ç½®æ¨£å¼

            // å–å¾—è¡¨å–®è³‡æ–™
            const course = document.getElementById('course').value;
            const lesson = document.getElementById('lesson').value;
            const chapter = document.getElementById('chapter').value;

            const params = new URLSearchParams({
                'èª²ç¨‹': course,
                'èª²å ‚': lesson,
                'ç« ç¯€': chapter,
                'å¯†ç¢¼': (document.getElementById('password').value || '').trim()
            });

            // å»ºç«‹å®Œæ•´çš„ API è«‹æ±‚ç¶²å€
            const requestUrl = `${API_URL}?${params.toString()}`;

            try {
                const response = await fetch(requestUrl);
                if (!response.ok) {
                    // å¦‚æœä¼ºæœå™¨å›æ‡‰é 2xx ç‹€æ…‹ç¢¼ï¼Œä¹Ÿè¦–ç‚ºéŒ¯èª¤
                    throw new Error(`ä¼ºæœå™¨éŒ¯èª¤ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
                }
                const data = await response.json(); // è§£æ JSON å›æ‡‰
                showResult(data);
            } catch (error) {
                showError(error);
            } finally {
                isQuerying = false;
                unlockSelects();
                unlockPassword();
            }
        }

        // é¡¯ç¤ºæŸ¥è©¢çµæœ
        function showResult(data) {
            const resultDiv = document.getElementById('result');

            // æ ¹æ“š API å›å‚³çš„ status æ±ºå®šé¡¯ç¤ºå…§å®¹
            if (data.status === 'success') {
                const links = (Array.isArray(data.links) && data.links.length > 0)
                    ? data.links
                    : (data.link ? [data.link] : []);
                const list = links
                    .map((lnk, i) => `<li class="mb-1"><a class="text-blue-600 hover:underline break-all" href="${lnk}" target="_blank">é€£çµ ${i + 1}</a></li>`)
                    .join('');
                resultDiv.innerHTML = `
                        <div class="p-4 border rounded-lg">
                            <div class="text-sm text-gray-500">èª²ç¨‹è³‡æº</div>
                            <ul class="list-disc pl-5 mt-1">${list}</ul>
                        </div>`;
                resultDiv.className = 'mt-6 text-base text-gray-800';
                hidePassword(true);
            } else if (data.status === 'forbidden') {
                showPassword(true);
                const msg = data.message || 'å¯†ç¢¼éŒ¯èª¤æˆ–ç¼ºå°‘å¯†ç¢¼ã€‚';
                resultDiv.innerHTML = `ğŸ”’ ${msg}`;
                resultDiv.className = 'mt-6 text-base font-medium text-amber-600';
            } else {
                // è™•ç† 'not_found' æˆ– 'error' ç‹€æ…‹
                const errorMessage = data.message || 'ç™¼ç”ŸæœªçŸ¥çš„éŒ¯èª¤ã€‚';
                resultDiv.innerHTML = `âŒ æŸ¥è©¢å¤±æ•—ï¼š${errorMessage}`;
                resultDiv.className = 'mt-6 text-base font-medium text-red-600';
            }
        }

        // è™•ç†éŒ¯èª¤
        function showError(error) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`;
            resultDiv.className = 'mt-6 text-base font-medium text-red-600';
            console.error('Fetch Error:', error);
        }

        // å°å·¥å…·ï¼šæ¸…ç©ºçµæœ
        function clearResult() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '';
            resultDiv.className = 'mt-6 text-base font-medium';
        }

        // å¯†ç¢¼å€é¡¯ç¤º/éš±è—
        function showPassword(focus = false) {
            passwordGroup.classList.remove('hidden');
            passwordInput.required = true;
            if (focus) passwordInput.focus();
        }
        function hidePassword(reset = false) {
            passwordGroup.classList.add('hidden');
            passwordInput.required = false;
            if (reset) passwordInput.value = '';
        }

        // åœ¨é¸æ“‡ç« ç¯€å¾Œï¼Œé æª¢æ˜¯å¦éœ€è¦å¯†ç¢¼ï¼Œè‹¥ä¸éœ€è¦ç›´æ¥é¡¯ç¤ºé€£çµ
        async function previewLinks(course, lesson, chapter) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'æª¢æŸ¥ä¸­...';
            resultDiv.className = 'mt-6 text-base font-medium text-gray-500';

            try {
                const params = new URLSearchParams({
                    'èª²ç¨‹': course,
                    'èª²å ‚': lesson,
                    'ç« ç¯€': chapter
                });
                // å¾Œç«¯ä¸å†ç®¡ç†å¯†ç¢¼ï¼Œé æª¢åƒ…ç¢ºèªæ˜¯å¦å­˜åœ¨é€£çµ
                const url = `${API_URL}?${params.toString()}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`ä¼ºæœå™¨éŒ¯èª¤ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
                const data = await response.json();
                // å¾Œç«¯å°‡åšæœ€çµ‚é©—è­‰ï¼Œé€™è£¡æç¤ºè¼¸å…¥å¯†ç¢¼ï¼ˆè¼¸å…¥ 6 ä½å¾Œè‡ªå‹•æŸ¥è©¢ï¼‰
                // åƒ…åœ¨ä¸‰å€‹é¸æ“‡çš†å­˜åœ¨æ™‚é¡¯ç¤ºå¯†ç¢¼
                if (hasAllSelections()) {
                    showPassword(true);
                    resultDiv.innerHTML = `è¼¸å…¥å¯†ç¢¼å¾Œæœƒè‡ªå‹•é€å‡ºæŸ¥è©¢`;
                    resultDiv.className = 'mt-6 text-base font-medium text-amber-600';
                } else {
                    hidePassword(true);
                }
            } catch (err) {
                showError(err);
            }
        }

        // å­¸ç”Ÿç«¯ä¸å†éœ€è¦æœ¬åœ° PIN è¨ˆç®—ï¼Œåƒ…è¼¸å…¥èˆ‡å‚³éçµ¦å¾Œç«¯
    </script>
</body>

</html>
